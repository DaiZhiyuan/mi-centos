#version=DEVEL
# Install OS instead of upgrade
install
text
reboot
# Use CDROM installation media
cdrom
# System keyboard
keyboard us
# System language
lang en_US

# Setup network interfaces via DHCP
network --device=eth0 --bootproto=dhcp --onboot=yes

#set root pw here (required by KS), remove pw in post
rootpw temp
firewall --enabled --service=ssh
authconfig --enableshadow --passalgo=sha512
firstboot --disabled

# SELinux configuration
# By default, selinux is enforcing
#selinux --enforcing
selinux --permissive

# Installation logging level
logging --level=info

# System timezone
timezone  Etc/UTC

# Bootloader
bootloader --location=mbr --driveorder=vda --append="tsc=reliable divider=10" 

# Clear the Master Boot Record
zerombr

# Partition clearing information
clearpart --all --initlabel

part / --fstype ext4 --size=8192 --asprimary --ondisk=vda
part swap --fstype swap --size=1024 --asprimary --grow --ondisk=vda

%packages --nobase
@core

acpid
duo_unix
iputils
libduo
man
me-centos
ntp
ntpdate
pam_duo
parted
vim-common
vim-enhanced
vim-minimal
wget

%end

%post --log=/var/log/ks.post.log
# Remove root password
passwd -d root

# Create MOTD 
cat << MOTD > /etc/motd.joyent
   __        .                   .
 _|  |_      | .-. .  . .-. :--. |-
|_    _|     ;|   ||  |(.-' |  | |
  |__|   \`--'  \`-' \`;-| \`-' '  ' \`-'
                   /  ;  Instance (centos 6.5 2.5.1)
                   \`-'   http://wiki.joyent.com/jpc2/Centos

MOTD

# Create rc.local
cat << EOF > /etc/rc.d/rc.local
#!/bin/sh
#
# This script will be executed *after* all the other init scripts.
# You can put your own initialization stuff in here if you don't
# want to do the full Sys V style init stuff.

# This script must run on each boot
# for your Joyent VM to work
# Do not comment this out
(/lib/smartdc/joyent_rc.local)


if [[ -f /etc/motd ]] ; then
  rm -f /etc/motd
  ln -sf /etc/motd.joyent /etc/motd
fi

if [[ ! -h /etc/issue ]] ; then
  ln -sf /etc/motd.joyent /etc/issue
fi

if [[ ! -h /etc/issue.net ]] ; then
  ln -sf /etc/motd.joyent /etc/issue.net
fi

if [[ ! -d /var/lock/subsys ]] ; then
  mkdir -p /var/lock/subsys
fi

touch /var/lock/subsys/local
EOF

# Link appropriate motd
ln -sf /etc/motd.joyent /etc/issue
ln -sf /etc/motd.joyent /etc/issue.net

# Link rc.local
ln -sf /etc/rc.d/rc.local /etc/rc.local

# Link product
ln -sf /lib/smartdc/product /etc/product

# Make sure the public (eth0) and private (eht1) interfaces are setup correctly
cat << ETH0 > /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE="eth0"
ONBOOT="yes"
BOOTPROTO="dhcp"
ETH0

cat << ETH1 > /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE="eth1"
ONBOOT="yes"
BOOTPROTO="dhcp"
ETH1

%end
